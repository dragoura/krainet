stages:
  - build
  - test
  - deploy

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

build-image:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
      alias: docker
      command: ["--tls=false"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - until docker info >/dev/null 2>&1; do echo "Waiting for Docker daemon..."; sleep 2; done
    - docker version
    - docker info
    - echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$CI_COMMIT_SHA" -t "$IMAGE_NAME:latest" .
    - docker push "$IMAGE_NAME:$CI_COMMIT_SHA"
    - docker push "$IMAGE_NAME:latest"
    - echo "IMAGE=$IMAGE_NAME:latest" > build.env
  artifacts:
    reports:
      dotenv: build.env

unit-test:
  stage: test
  image: golang:1.23
  needs: ["build-image"]
  script:
    - go version
    - go test ./cmd/...

deploy:
  stage: deploy
  image: alpine:3.20
  needs: ["build-image", "unit-test"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - apk add --no-cache openssh-client rsync
    - mkdir -p ~/.ssh
    - printf "%s" "$DEPLOY_SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - DB_URL="postgres://${APP_DB_USER}:${APP_DB_PASSWORD}@${APP_DB_HOST}:${APP_DB_PORT}/${APP_DB_NAME}?sslmode=disable"
  script:
    - ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" "sudo -n mkdir -p $DEPLOY_PATH && sudo -n mkdir -p $DEPLOY_PATH/deploy/nginx"
    - rsync -e 'ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519' --rsync-path="sudo -n rsync" -avz --delete deploy/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/deploy/"
    - ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 "$DEPLOY_USER@$DEPLOY_HOST" \
        "sudo -n env IMAGE=$IMAGE docker compose -f $DEPLOY_PATH/deploy/docker-compose.yml pull && \
         sudo -n env IMAGE=$IMAGE DATABASE_URL='$DB_URL' docker compose -f $DEPLOY_PATH/deploy/docker-compose.yml up -d --remove-orphans"
  environment:
    name: production
    url: http://$DEPLOY_HOST
